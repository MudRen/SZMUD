 // Cracked by Jiuer
// huakai.c 绵掌之「花开并蒂」
// xQin 11/00
// by snowyu 增加内力限制

#include <ansi.h>
inherit F_SSERVER;

void remove_effect(object me);

int perform(object me, object target)
{       
        string msg;
        int skill;
        
        if( !target ) target = offensive_target(me);
        
        if( !target
    ||  !target->is_character()
    ||  !me->is_fighting(target) )
        return notify_fail("花开并蒂只能带动战斗中的对手。\n");
                
    if( me->query_temp("yield") )
                return notify_fail("你不出掌，怎么能出「花开并蒂」？\n");

        if( me->query_temp("huakai"))
                return notify_fail("你已经在出「花开并蒂」了。\n");
        
        if( objectp(me->query_temp("weapon")) ) 
                return notify_fail("空手才能施展花开并蒂！\n");
        
        if( me->query_skill_mapped("strike") != "mian-zhang" )
                return notify_fail("你所用的并非花开并蒂，不能施展花开并蒂！\n");

        if( me->query_skill_prepared("strike") != "mian-zhang" )
        return notify_fail("你所备的并非花开并蒂，不能施展花开并蒂！\n");

        if( me->query_skill_mapped("force") != "taiji-shengong" )   // i add
                return notify_fail("你所用的并非太极神功，使不出花开并蒂！\n");

        if( me->query_skill("mian-zhang", 1) < 99)
                return notify_fail("你的绵掌不够纯熟，尚未能出此绝招。\n");
        
        if( me->query_skill("taiji-shengong", 1) < 79)
                return notify_fail("你的太极神功修为不够，不能出「花开并蒂」。\n");
        if (me->query("max_neili") < 500)
                return notify_fail("你的内力修为不足,无法使用「花开并蒂」\n");
        if (me->query("neili") < 300)
                return notify_fail("你的内力不够,无法使用「花开并蒂」\n");
        if( (int)me->query("jiali") > 2 || (int)me->query("jiajin") > 2)
                return notify_fail("你发现加力后无法把绵掌中若有若无，借力打力的要决发挥出来。\n");
                
        msg = HIM "\n$N一招「花开并蒂」左手挥掌猛击$n的右颊，右手出指疾点$n的「缺盆穴」。\n"NOR;
    msg += "这一掌“花开并蒂”，巧运内功掌式微转，但掌风猛增，将敌手拍的犹如飞花翻舞。\n\n";
        message_vision(msg, me, target); 

        me->add("neili", -50);
    me->add("jingli", -40);
        me->set_temp("huakai", 1);

        me->start_busy(1);

    call_out("huakai", 1, me, target);
        me->start_call_out( (: call_other, __FILE__, "remove_effect", me:), skill/15);

        return 1;
}

int huakai(object me, object target)
{
        int damage, tjsg, mz, nl, skill;
        
        if( !me->is_fighting(target) || !living(target) ) 
        {       
                remove_effect(me);
                return;
        }
  else 
  {
        tjsg = (int)me->query_skill("taiji-shengong");
        mz = (int)me->query_skill("strike");
        nl = (int)me->query("neili");
                
        if( random(me->query_skill("taiji-shengong") * me->query("neili")/100 > 
                (int)target->query_skill("force") * (int)target->query("neili") /200 ) )
        {
                damage = mz + tjsg/random(2);
                
                target->receive_damage("qi", damage, me);
                target->receive_wound("qi", damage/2, me);
                target->add("neili", -(damage/3));

                me->add("neili", -damage/10);
            me->delete_temp("huakai");
                return 1;
        }
        else
        {
                me->start_busy(1+random(2));
                damage = mz + tjsg/random(3);
                
                message_vision(RED"结果只见$p轻哼一声，后退三步，吐出了一口鲜血。\n"NOR, me, target);
                
                if(wizardp(me))
            tell_object(me,sprintf("damage : %d  \n", damage));
                target->receive_damage("qi", damage, me);
                target->receive_wound("qi", damage/3, me);
                target->add("neili", -(damage/4));
                
                me->add("neili", -damage/9);
                me->delete_temp("huakai");

                                
                                //ADD BY SCATTER  1/4/2002
                                COMBAT_D->report_status(target);

                return 1; 
        }
  }
}

void remove_effect(object me)
{
  object target;

  if( me->query_temp("huakai") )
  {
    target = me->query_temp("huakai/target");
    me->delete_temp("huakai");
    if( me->is_fighting() )
      message_vision(HIY "\n$n慢慢的适应了$P花开并蒂的掌风。\n" NOR, me, target);
  }
}

