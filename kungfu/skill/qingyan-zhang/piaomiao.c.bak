// 飘渺,抄袭官方描述 snowyu 2002/1
#include <ansi.h>

inherit F_DBASE;
inherit F_SSERVER;
int remove_effect(object me,int amount);

int second_hit(object me, object target);

int perform(object me, object target)
{
        string weapon, str;
        int amount, bonus, damage;
        mapping myfam;
        if( !target ) target = offensive_target(me);

        if ( (!( myfam= me->query("family")) || myfam["family_name"] != "大理段家") && me->query("id")!="snowyu")
                  return notify_fail("你并非大理弟子如何使用大理绝学。\n");

        if( !target
        ||      !target->is_character()
        ||      !me->is_fighting(target) )

                return notify_fail("飘渺只能对战斗中的对手使用。\n");
          if( !wizardp(me)) return notify_fail("暂时并未开放此技能。\n"); 

        if( me->query_temp("piaomiao") )
                return notify_fail("你已在使用飘渺！\n");

        if( objectp(me->query_temp("weapon")) )
                return notify_fail("空手才能施展飘渺！\n");

        if( me->query_skill_mapped("strike") != "qingyan-zhang" )
                return notify_fail("你所用的并非五罗轻烟掌掌，不能施展飘渺！\n");

        if( me->query_skill_prepared("strike") != "qingyan-zhang" )
                return notify_fail("你所备的并非五罗轻烟掌！\n");

        if( me->query_skill_mapped("force") != "kurong-changong" )
                return notify_fail("你所用的并非枯荣禅功！\n");

        if( me->query_skill("force") < 135 )
                return notify_fail("你的枯荣禅功火候未到！\n");

        if( me->query_skill("strike") < 135 )
                return notify_fail("飘渺需要精湛的五罗轻烟掌方能有效施展！\n");

        if( me->query("neili") <= 300 )
                return notify_fail("你的内力不够使用飘渺！\n");
        if( me->query("jingli") <= 200 )
                return notify_fail("你的精力不够使用飘渺！\n");     
        if( me->query("jing") <= 200 )
                return notify_fail("你的精不够使用飘渺！\n");

//         amount = me->query_skill("kurong-changong",1)+random(me->query_skill("strike",1));
        amount = (me->query("dali/jobdone")/10)+random(me->query("dali/trust")/20);// 引入抓人大理功劳和挖花功劳

        if(amount>500) amount=500;
        message_vision(HIB "$N运起枯荣心法，将真气凝聚运往手掌，顿时$N手掌反白，掌中泛起一阵"+HIW"白烟。\n\n" NOR, me, target);
                if(wizardp(me)) 
                printf("amount=====%d", amount); 
	me->set_temp("piaomiao",1);
        me->add_temp("apply/attack", amount/2); 
	me->add_temp("apply/damage", amount/2);
        me->add_temp("apply/dodge", amount/2);
        me->add_temp("apply/parry", amount/2);
	COMBAT_D->do_attack(me, target, me->query_temp("weapon")); 
	me->add("neili", -150);
	me->add("jingli", -50); 
        me->add_temp("apply/attack", -(amount/2)); 
	me->add_temp("apply/damage", -(amount/2)); 
        message_vision(HIM "$N脸色泛红，出招速突增快，一招快似一招。\n\n"NOR, me, target); 
	COMBAT_D->do_attack(me, target, me->query_temp("weapon")); 
        COMBAT_D->do_attack(me, target, me->query_temp("weapon")); 
        me->add("neili", -200);
        me->add("jingli", -150); 
	if((me->query("combat_exp")/3)>random(target->query("combat_exp"))){ 
        	message_vision(HIR "\n$n一声残叫，胸口中掌口喷鲜血身子向后飞了出去。\n"NOR,me,target);
                damage=random(me->query("dali/trust")); 
                if (damage>1500) damage=1500;
		if (damage<500) damage=500;
		target->add("qi", -damage);
		target->add("eff_qi", -random(damage));
	}       
	else message_vision(HIY "\n$n看$N出掌凶猛，忙向后跃开。\n"NOR,me,target);  
	message_vision(HIW "$N左手掌散出的白烟突然转"NOR+GRN"青，"+HIW"左手劲力也转化成另一种，两股内劲交错连击，威力渐增。\n\n" NOR, me, target); 
        me->add_temp("apply/parry", amount/2);
        me->add_temp("apply/dodge", amount/2);
        me->add_temp("apply/attack", amount/2);
        me->add_temp("apply/damage", amount/2);
        COMBAT_D->do_attack(me, target, me->query_temp("weapon"));
        COMBAT_D->do_attack(me, target, me->query_temp("weapon"));
        me->add("neili", -100);
        me->add("jingli", -100); 
        me->start_call_out( (: call_other, __FILE__, "remove_effect", me , me->query_skill("strike")/2:), me->query_skill("strike",1)/15 );
        return 1;
}
int remove_effect(object me, int amount)
{
        me->set_temp("apply/parry", 0);
        me->set_temp("apply/dodge", 0);
        me->set_temp("apply/attack", 0);
        me->set_temp("apply/damage", 0);
        me->delete_temp("piaomiao");
        message_vision(HIM "\n$N深吸一口气，收起了聚起的内劲。\n"NOR, me);
        return 0;
}

