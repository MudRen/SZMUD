// Room Of Mxj
// have a good day
//Cracked by Kafei
//kane
//maco changed 
#include <ansi.h>
#include <combat.h>
#include <weapon.h>
inherit COMBINED_ITEM;
inherit F_COMMAND;


int bash_weapon(object me, object victim);

void create()
{
	set_name(YEL"小石子"NOR, ({"xiao shizi", "shizi"}));
	if (clonep())
	set_default_object(__FILE__);
	else {
	set("unit", "堆");
	set("base_unit","粒");
	set("long", "这是随处可见的小石子。\n");
	set("value", 0);
	}
	set_amount(20+random(20));
//	init_throwing(5);
	setup();
}

int init()
{
	add_action("do_tanzhi", "tan");      
	add_action("do_liantan", "liantan");   
}

int do_liantan(string arg)
{
	string* xuedao = ({
	"巨骨穴",
	"地仓穴",
	"肩井穴",
	"颊车穴",
	"承泣穴",
	"风池穴",
	"章门穴",
	"风府穴",
	"精促穴",
	"陶道穴",
	"强间穴",
	"少海穴",
	"犊鼻穴",
	"神门穴",
	"华盖穴",
	"大椎穴",
	"凤尾穴",
	"至阳穴",
	"劳宫穴",
	"百会穴",
	"灵台穴",
	"太阳穴",
	"膻中穴",
	"命门穴",
	"鸠尾穴",
	"三阴交",
	"天柱穴"
	});

	int skill,skill2,tz,tz_busy,exp1,exp2,exp0,jiali;
	object me = this_player();
	object victim,weapon,ob;
	mapping myfam;
	
	if (!arg)    
		return notify_fail("你要干什么？\n");
	if (!(victim = present(arg,environment(me))))
		return notify_fail("这里并无此人！\n");	
		
	if (!victim)
		return notify_fail("这里并无此人！\n");

	if (!living(victim))
		return notify_fail("这不是活物！\n");	
		
	if (victim == me) return notify_fail("何必多此一举？\n");	
	
	if( environment(me)->query("no_fight") )
                return notify_fail("在这里不能攻击他人。\n");
        
       	myfam = (mapping)me->query("family");	
	if( !myfam || myfam["family_name"] != "桃花岛" )
                return notify_fail("你非桃花弟子，不能使用九指连弹的绝技。\n");                

	if( me->query_skill_mapped("force") != "bitao-xuangong" )
		return notify_fail("你所用的并非碧涛玄功，无法使用九指连弹的绝技。\n");
	
	if( me->query_temp("liantan",1) )
		return notify_fail("你已在使用九指连弹！\n");
		
	if (me->is_busy() || me->query_temp("pending/exercising"))
		return notify_fail("你现在正忙着呢。\n");		
	
	if (me->query_skill("tanzhi-shentong", 1) < 240)
		return notify_fail("你的弹指神通不够熟练。\n");		
		
	if (me->query_skill("bitao-xuangong", 1) < 240)
		return notify_fail("你的碧涛玄功不够熟练。\n");	
	
			
	if ((int)me->query("jingli") < 500)
		return notify_fail("你的精力不够。\n");
	if ((int)me->query("neili") < 1000)
		return notify_fail("你的内力不够。\n");		

	ob = this_object();
	if (ob->query_amount() < 5)
		return notify_fail("你的小石子数量不够。\n");		
	
	if( !victim
        ||  !victim->is_character()
        ||  !me->is_fighting(victim) )
                return notify_fail("九指连弹只能对战斗中的对手使用。\n");
					
	skill = me->query_skill("tanzhi-shentong", 1);
	skill2 = victim->query_skill("dodge",1);	
	exp1 = me->query("combat_exp");
	exp2 = victim->query("combat_exp");
	
	jiali = me->query("jiali");
	
	tz = (65+100*(skill-skill2)/skill)*(2*exp1)/(exp1+exp2);
	tz_busy = 2+(skill-240)/20;				
			
	message_vision(HIW"$N清啸一声，右手手指或曲或伸，轮指连弹，只听见嗤嗤的利器破空之声不断！\n
只见$N的袍袖中急射而出五颗石子，以凌厉至极之势分袭$n膻中、命门、百会、太阳等致命大穴！\n"NOR, me, victim);
	me->add("neili",- 400);
	
// 成功
	if (tz>random(100)) {
	message_vision(HIY"$n只觉得"+xuedao[random(sizeof(xuedao))]+"一阵酸麻，气血翻涌，顿时动弹不得！\n"NOR, me, victim);
	victim->start_busy(tz_busy);
	victim->receive_wound("qi", jiali);
	victim->receive_damage("qi", jiali);
	add_amount(-5);   
	me->set_temp("liantan",1);
//	me->start_call_out( (: call_other, __FILE__, "remove_effect", me :),tz_busy*2+4 );
//	call_out("checking", 1, me); 
	call_out("remove_effect",tz_busy*2+4,me );
	return 1;
	}
	else {
	message_vision(CYN"$n见来势不妙，展开轻功，侧身躲过。\n"NOR, me, victim);	
	me->start_busy(2);
	return 1;
	}	
}
void checking(object me)
{
	if( !me->is_fighting() ) {
	message_vision(CYN "\n$N见战局已毕，便即收起了九指连弹的攻势。\n"NOR,me);
	me->delete_temp("liantan");
	return ;
	}
}	

int remove_effect(object me)
{
	
	message_vision(CYN"$N只觉指力渐弱，再如此快攻恐怕后继乏力，当下不动声色，暗暗收了九指连弹的攻势。\n"NOR,me);
	me->delete_temp("liantan");
	return 0;
}	

int do_tanzhi(string arg)
{
	int skill, skill2, thr, dod, tz, parr, diff, jiali, exp, exp2;
	string str, dodge_skill, result, *limbs, limb;
	object me = this_player();
	object victim,weapon;

	if (!arg)    
		return notify_fail("你要干什么？\n");

	if (!(victim = present(arg,environment(me))))
		return notify_fail("这里并无此人！\n");

	if (!victim)
		return notify_fail("这里并无此人！\n");

	if (!living(victim))
		return notify_fail("这不是活物！\n");

	if( me->is_busy() )
		return notify_fail("你前一个动作还没有做完。\n");

	if (victim == me) return notify_fail("何必多此一举？\n");

//	if (!wizardp(me) && wizardp(victim))
//		return notify_fail("大胆！竟想谋害巫师！\n");
        
	if( environment(me)->query("no_fight") )
                return notify_fail("在这里不能攻击他人。\n");

	if (me->query_skill("tanzhi-shentong", 1) < 120)
		return notify_fail("学小孩弹石子，不害臊吗？\n");

	tz = me->query_skill("tanzhi-shentong", 1);
	dod = (int)victim->query_skill("dodge");
	parr = (int)victim->query_skill("parry");
	skill = tz/10+random(tz)/2;
	skill2 = (dod + parr)/10;
	diff = skill-skill2;
	jiali = me->query("jiali");
	limbs = victim->query("limbs");
	exp = me->query("combat_exp");
	exp2 = victim->query("combat_exp");
	me->add("neili",- jiali/2);
	limb = limbs[random(sizeof(limbs))];

	message_vision(HIW"$N信手拈起一粒小石子，扣在拇指食指之间，“哧”的一声急响，小石子向$n激射而去......\n" NOR, me, victim);

//	if( exp/3+random(exp/2) > exp2 /2 && skill > skill2){
	if(skill > skill2){

	weapon = victim->query_temp("weapon");

	if( !victim->query_temp("weapon") ) {

		if(jiali >= 240) message_vision(HIY"$n刚听到一点声息，小石子转瞬间划过长空，已击中$n"+limb+"，先声夺人，威不可当！\n" NOR, me, victim);

		else if(jiali >= 200) message_vision(HIY"但听小石子破空之声响亮异常，来势比铁胎弹弓所发还要急劲，转瞬间已击中$n"+limb+"！\n" NOR, me, victim);
		else message_vision(HIY"$n被打个措手不及，虎口登时鲜血长流，手臂再也抬不起来。\n" NOR, me, victim);

	victim->receive_wound("qi", random(jiali) +random(10));
	victim->receive_damage("qi", jiali + random(jiali) + random(10));
	}
	else message_vision(HIY"小石子破空飞至，撞在$N手中的" + weapon->name() + HIY"上。\n"NOR,victim);
   
	bash_weapon(me,victim);
	victim->start_busy(1+random(2));

	victim->receive_wound("qi", random(jiali/5) + 10);
	victim->receive_damage("qi", jiali/2 + random(10));
	result = COMBAT_D->eff_status_msg((int)victim->query("qi") * 100 /(int)victim->query("max_qi"));
	message_vision("( $N"+result+" )\n", victim);
		if(victim->query("eff_qi") < 0 && victim->query("qi") < 0 && jiali >200 
		&& victim->query("race") == "人类")
		message_vision(HIR"\n$n身子一仰，向後便摔，喷出一口鲜血。\n" NOR, me, victim);



	if( !victim->is_killing(me) ) victim->kill_ob(me);
	me->start_busy(1+random(2));
	if( victim->query("combat_exp") > me->query("combat_exp"))
	me->add("combat_exp", 1);
	add_amount(-1);      

	return 1;
	}
	
	else {
        dodge_skill = victim->query_skill_mapped("dodge");
                if( !dodge_skill ) dodge_skill = "dodge";
                str = SKILL_D(dodge_skill)->query_dodge_msg(limb);
                message_vision(str, me, victim);

//	message_vision("$n发现不妙，赶紧向後跃开数丈，躲了开去。\n" NOR, me, victim);
		if( !victim->is_killing(me) ) victim->kill_ob(me);
	me->start_busy(random(2));
		if (query_amount() >1) add_amount(-1);
                else destruct(this_object());
	}
	return 1;
}    

int bash_weapon(object me, object victim)
{
        object ob;
        int wap, wdp, jiali;
	jiali = me->query("jiali");

        if( (me->query("neili") > 100)
        &&      ob = victim->query_temp("weapon") ) {
                wap = (int)me->query("neili")
                        + (int)me->query_str()
                        + (int)me->query_skill("tanzhi-shentong",1);
                wdp = (int)ob->weight() / 500
                        + (int)ob->query("rigidity")
                        + (int)victim->query_str()
                        + (int)victim->query_skill("parry")/2;
                wap = random(wap);
                if( wap > 2 * wdp 
                && ob->query("weapon_prop/damage") < 90 ) {
			if(jiali < 200) message_vision(HIW "只听见「啪」地一声，$N手中的" + ob->name() + HIW"已经断为两截！\n" NOR, victim );
			else message_vision(HIW"小石子一撞之下，登时火星四溅，石子碎片八方乱射，「啪」地一声，"+ob->name()+HIW"断为两截！\n"NOR, victim);
			
                        ob->unequip();
                        ob->move(environment(victim));
                        ob->set("name", "断掉的" + ob->query("name"));
                        ob->set("value", 0);
                        ob->set("weapon_prop", 0);
                        victim->reset_action();
                } else if( wap > wdp ) {
                
                        if(jiali < 200) message_vision(HIW"$N只觉得手中" + ob->name() + HIW"把持不定，脱手飞出！\n"NOR, victim);
			else message_vision(HIW"小石子一撞之下，炸得粉碎，震得$N虎口疼痛，"+ ob->name() + HIW"摔在地下！\n"NOR, victim);
	
                        ob->unequip();
                        ob->move(environment(victim));
                        victim->reset_action();
                } else if( wap > wdp / 2 ) {
			message_vision("$N只觉得手中" + ob->name() + "一震，险些脱手！\n",
                                victim);
                } else {
                        message_vision("$N射出的小石子和$n的"+ob->name()+"相击，冒出点点的火星。\n", me, victim);
                }
        }
}


