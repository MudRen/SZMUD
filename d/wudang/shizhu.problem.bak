// Code of ShenZhou
// shizhu.c 石柱 
// by Fang 8/19/96
// modified by Ryu 6/15/97;
// xQin 8/00
//reader 10/2001

inherit ROOM;
#include <ansi.h>
string look_lu();
int burnt, start_burn; 
int is_burning();

void create()
{
        set("short", "石柱");
        set("long", @LONG
这是南岩宫前的一根石柱，雕成龙形，自峭壁上横出，犹如飞龙在天。龙首
刻一香炉，在此上香称为“上龙头香”，是香客的最大心愿。石柱仅粗如屋梁，
旁无扶栏，前有白云缭绕，下有万丈深渊，稍一失足，即尸骨无存。
LONG
        );
        set("outdoors", "wudang");
        set("item_desc",([
            "lu" : ( :look_lu:),
        ]));

        set("exits", ([
                "northup" : __DIR__"nanyanfeng",
        ]));
        set("cost", 9);
        setup();
        burnt = 0;
        call_out("burn", 120, 1);

}
void init()
{
        add_action("do_mianbi","面壁");
        add_action("do_mianbi","mianbi");
        add_action("do_jing", "jing");

}
int do_mianbi()
{
        object me, mengzhu, room;
        int shen, ep, gain;
        me = this_player();
        shen = me->query("shen");
        ep = me->query("combat_exp");

        if (me->is_busy()
        || me->query_temp("pending/exercising")
        || me->query_temp("exit_blocked"))
                return notify_fail("你现在正忙着呢。\n");

        if (me->query("jing") < 200 || me->query("jingli") < 200)
        return notify_fail("你觉得烦躁不安，难以聚精入定。\n");
        
        message_vision("$N面对着石柱跌坐静思，良久，似有所悟。\n", me);

        me->start_busy(10);
        me->set("jing",1);
        me->add("jingli", -200);

        if(!( room = find_object("/d/taishan/fengchan")) )
        room = load_object("/d/taishan/fengchan");
        seteuid(getuid(me));
        if( !objectp(mengzhu = present("mengzhu", room)) ){
        mengzhu = new("/clone/npc/meng-zhu");
        mengzhu->move("/d/taishan/fengchan");
        }

        if (userp(me) && me->query("id") != mengzhu->query("winner") ){
        if (shen > 10000 && shen > ep){
        gain = (shen - ep) * 1000 / ep; 

        if (gain > 20) gain = 20;
        if (gain < 2) gain=2;

        if (me->query("family/family_name") != "武当派") gain = gain/2;

        me->add("combat_exp", gain * 10 + random(gain*5));
        me->set("shen", me->query("combat_exp"));

  //      if (me->query("family/family_name") == "武当派")
        me->add("potential", gain * me->query_skill("taoism") / 25
        + random(gain*me->query_skill("taoism")/60));

        if (me->query("potential") > me->query("max_potential"))
        me->set("potential", me->query("max_potential"));
                if (me->query("family/family_name") == "武当派")
                me->improve_skill("taoism",random(gain));
        }
    }
        return 1;
}
int is_buring()
{
        return (burnt < 3);
}       

void burn(int phase)
{
        burnt = phase;
        
        if (burnt < 3) call_out("burn", 120, phase + 1);

} 
string look_lu()
{

        switch (burnt) {
        case 0:
                return(YEL"香炉上供奉着新上的香火，芬芳四周。\n"NOR);
                break;
        
        case 1:
                return(YEL"香炉上香烟缭绕，香火烧得正旺。\n"NOR);
                break;
                
        case 2:
                return(YEL"香炉上的香火已经烧了大半，几缕余烟，奄奄欲息。\n"NOR);
                break;
                
        default:
                return(YEL"香炉上只剩下一堆烟灰，等着有人敬(jing)龙头香！！\n"NOR);
                break;
                
                }
}
int do_jing(string arg)
{
        object obj, me;
        
        if ( !objectp(me = this_player()) ) return 0;   
        
        if (!arg ) return notify_fail("你要敬什么？\n");  
                                        
        if( !objectp(obj = present(arg, me)) )
                return notify_fail("你身上没有这样东西。\n");
                   
        if ( obj->query("id") != "incense" 
         ||  obj->is_character() ) return notify_fail("只能敬香！\n");  
        
        burnt = 0;
        remove_call_out("burn");
        call_out("burn", 120, 1);
        
        message_vision(HIC"$N拿出一"+obj->query("unit")+obj->query("name")
                +"，恭恭敬敬地插在香炉上。\n"NOR, me);
        if (me->query("family/family_name") == "武当派" )
        me->add("combat_exp", 10+random(20));
        me->add("potential", 50+random(10));    
        if (me->query("age") < 20 && me->query("wudang/offerring") < 60)
        me->add("wudang/offerring", 2);
        if (me->query("age") < 30 && me->query("wudang/offerring") < 120)
        me->add("wudang/offerring", 2);
        if (me->query("age") > 30 && me->query("wudang/offerring") < 150)
        me->add("wudang/offerring", 2);                                                                                                 
        
        return 1;               
}

